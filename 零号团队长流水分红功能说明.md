# 零号团队长无限代流水分红功能说明

## 功能概述

实现了零号团队长的无限代流水分红功能。零号团队长可以享受其线下所有代际会员流水的分红，无论层级多远都计入分红基础。

## 核心逻辑

1. **分红基数计算**：
   - 分红基数 = 团队流水 - 推荐奖
   - 例如：团队充值100万，推荐奖30万，流水分红基数 = 70万

2. **分红比例**：
   - 最高70%的流水分红比例
   - 可在后台配置统一比例，或按职位设置不同比例

3. **与推荐奖的关系**：
   - 零号团队长可以同时获得：
     - 正常的推荐奖（一级、二级、三级）
     - 额外的流水分红（基于流水-推荐奖的基数）

## 实现内容

### 1. 数据库字段

需要在 `api_user` 表中添加以下字段：

```sql
-- 执行 add_zero_team_leader_field.sql 文件
ALTER TABLE `cloud_times_api_user` 
ADD COLUMN `is_zero_team_leader` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否为零号团队长：0-否，1-是' AFTER `is_agent`;
```

### 2. 代码修改

#### 2.1 ApiUser 模型 (`app/common/model/ApiUser.php`)
- 添加了 `get_infinite_level_ids()` 方法：获取无限代下级用户ID
- 添加了 `find_zero_team_leader()` 方法：向上查找零号团队长

#### 2.2 Index 控制器 (`app/api/controller/Index.php`)
- 在 `set_parent_commion()` 方法中添加了零号团队长流水分红逻辑
- 添加了 `set_zero_team_leader_water_income()` 方法：计算并发放流水分红

#### 2.3 UserRecharge 控制器 (`app/admin/controller/api/UserRecharge.php`)
- 在充值成功时添加了零号团队长流水分红逻辑
- 添加了 `set_zero_team_leader_water_income_for_recharge()` 方法

#### 2.4 配置文件 (`config/web.php`)
- 添加了 `zero_team_leader_water_income_rate` 配置项：统一流水分红比例

#### 2.5 资金流水类型 (`app/common.php`)
- 添加了类型 32：零号团队长流水分红

#### 2.6 后台配置页面 (`view/admin/config/index.html`)
- 添加了零号团队长流水分红比例配置界面

## 使用方法

### 1. 数据库迁移

执行 SQL 文件添加必要字段：
```sql
-- 执行 add_zero_team_leader_field.sql
```

### 2. 设置零号团队长

在数据库中设置用户为零号团队长：
```sql
UPDATE `cloud_times_api_user` SET `is_zero_team_leader` = 1 WHERE `id` = 用户ID;
```

### 3. 配置流水分红比例

在后台配置页面设置流水分红比例：
- 路径：系统配置 -> 零号团队长流水分红比例
- 设置比例（0-70%）

### 4. 触发流水分红

流水分红会在以下场景自动触发：
- 用户购买产品时
- 用户充值成功时

## 分红计算示例

假设：
- 用户A购买产品，金额：10000元
- 一级推荐奖比例：25%
- 二级推荐奖比例：5%
- 三级推荐奖比例：0%
- 零号团队长流水分红比例：50%

计算过程：
1. 推荐奖总额 = 10000 × 25% + 10000 × 5% + 10000 × 0% = 3000元
2. 流水分红基数 = 10000 - 3000 = 7000元
3. 零号团队长流水分红 = 7000 × 50% = 3500元

## 注意事项

1. **零号团队长标识**：需要在数据库中手动设置 `is_zero_team_leader = 1`
2. **分红比例限制**：建议不超过70%
3. **推荐奖计算**：流水分红会扣除已发放的推荐奖，避免重复计算
4. **充值场景**：充值通常没有推荐奖，所以分红基数就是充值金额
5. **职位配置**：如果使用职位区分，需要在配置中添加 `zero_team_leader_water_income_rate_职位名` 配置项

## 扩展功能（可选）

如果需要按职位设置不同的流水分红比例：

1. 在用户表中添加 `position` 字段
2. 在配置文件中添加对应职位的配置项，如：
   ```php
   'zero_team_leader_water_income_rate_职位1' => '50',
   'zero_team_leader_water_income_rate_职位2' => '60',
   ```
3. 代码已支持按职位获取不同的分红比例

## 测试建议

1. 设置一个测试用户为零号团队长
2. 创建下级用户并充值/购买产品
3. 检查零号团队长的资金流水，确认流水分红是否正确发放
4. 验证分红基数计算是否正确（流水-推荐奖）
